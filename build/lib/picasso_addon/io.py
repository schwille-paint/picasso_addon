import pandas as pd
import h5py
import os

#%%
def load_locs(path,container='locs'):
    """
    Returns localization .hdf5 from picasso as pandas.DataFrame and corresponding .yaml as list of dictionaries.
    
    Parameters
    ---------
    readpath : str
        Path to .hdf5 file as generated by Picasso
    container: str
        Must be set to:
            * 'locs' for '_locs', '_render' and '_picked' .hdf5 files as generated by picasso.render
            * 'groups' for '_pickprops' .hdf5 files as generated by picasso.render
        Defaults to 'locs'
    Returns
    -------
    locs : pandas.DataFrame
        Localization list stored under 'locs' in .hdf5 file
    locs_info : list
        list of dictionaries contained in .yaml corresponding to .hdf5 file
    """
    
    with pd.HDFStore(path,'r') as store:
        locs=store[container]
        
    ### Get corresponding .yaml file
    from picasso.io import load_info as load_info
    info=load_info(path)
    
    return locs,info

#%%
def save_locs(path,locs,info,mode=None):
    """
    Save processed df of locs file belonging to origin_path in .hdf5 file and corresponding list of dictionaries in .yaml file.
    
    Parameters
    ---------
    locs: pandas.DataFrame
        locs (as in picasso) but converted to pd.DataFrame format
    info: list(dict1,dict2,...)
        List of dictionaries belonging to locs, will be stored in .yaml
    path : str
        Path in which locs are stored
    mode: str
        If mode='picasso_compatible' locs will be stored as np.rec_array to be readable with picasso.filter module
    """
    
    if mode=='picasso_compatible':
        locs_rec=locs.to_records(index=False) # Convert to rec_array  
        with h5py.File(path, "w") as store:
            store.create_dataset("locs", data=locs_rec)
    else:
        with pd.HDFStore(path,'w') as store:
            store.put('locs', locs, format='fixed')
 
    ### Save info in .yaml
    from picasso.io import save_info as save_info
    save_info(os.path.splitext(path)[0]+'.yaml',
              info,
              default_flow_style=False)
    
    return

#%%
def _save_picks(locs,pick_diameter,path):
    '''
    
    '''
    x=locs.x
    y=locs.y
    centers = []
   
    for index, element in enumerate(range(len(x))):
        centers.append([float(x[index]),float(y[index])])
    
    picks = {'Diameter': float(pick_diameter), 'Centers': centers, 'Shape': 'Circle'}
 
    import yaml  as yaml
    with open(path, 'w') as f:
        yaml.dump(picks,f)
    
    return picks